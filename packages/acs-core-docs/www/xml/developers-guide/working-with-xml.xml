<sect1 id="working-with-xml" xreflabel="Working with XML Data in ArsDigita Community System">
<title>Working with XML Data in ArsDigita Community System</title>


<authorblurb><para>
by <ulink url="mailto:karlg@arsdigita.com">Karl Goldstein</ulink> 
</para></authorblurb>

<sect2 id="working-with-xml-perspective">
<title>Perspective</title>

<para>
The ArsDigita philosophy is not to put stuff into our toolkit
that is part of the core Oracle RDBMS. Oracle Corporation has thousands of
programmers, their most reliable product is the core RDBMS server, they have
documentation, training, support, etc. Oracle has wonderful support for XML
built into their core RDBMS from version 8.1.5 forward. This support is
available to any Oracle client, including an AOLserver running the ArsDigita
Community System. The XML support is made possible by the fact that the core
Oracle server is capable of running programs in procedural languages such as
Java and PL/SQL. 
</para>

<para>
Basically what we do for a site that needs to make heavy use of XML is to
download the appropriate Java libraries for Oracle&#39;s built-in Java VM.
After that it is just a question of how to use those libraries:
</para>

<itemizedlist>
<listitem><para><phrase>I want to grab some data from an Oracle table and publish it in
XML:</phrase> run the <computeroutput>xmlgen.getXML</computeroutput> procedure inside Oracle,
which will automatically figure out how to go from the Oracle data dictionary
into XML; AOLserver gets a big string of XML back from Oracle</para></listitem>

<listitem><para><phrase>I want to grab some data from a server elsewhere on the Internet
and stuff it into an Oracle table:</phrase> Take the entire XML document and
feed it to Oracle, then run <computeroutput>xmlgen.insertXML</computeroutput>.</para></listitem>

<listitem><para><phrase>I want to render some data stored in Oracle as XML and publish it
on the Web in HTML:</phrase> Here you have an Oracle CLOB column containing
an XML document. You want a reader to be able to view it in a standard
browser. You want to use XSL to render the XML document into HTML. Do this by
calling our <computeroutput>apply_xsl</computeroutput> procedure (invokes some Java code within
the database).</para></listitem>
</itemizedlist>

<para>
Generally AOLserver wants to parse XML that comes from a database table. In
this case, it makes sense to do the parsing that is already in the database 
</para>

</sect2>

<sect2 id="working-with-xml-overview">
<title>Overview</title>


<para>This document describes how to use XML to publish and retrieve data from
Oracle tables. The procedure relies on Oracle&#39;s XML parser and SQL to XML
utility, which makes it easy to transform a query result into a simple XML
document with the following general structure:</para>

<programlisting>
&lt;rowset&gt;
  &lt;row&gt;
    &lt;column1&gt;value&lt;/column1&gt;
    &lt;column2&gt;value&lt;/column2&gt;
    ...
    &lt;columnN&gt;value&lt;/columnN&gt;
  &lt;/row&gt;
  ...
&lt;/rowset&gt;
</programlisting>

<para>The parser is written in Java, but Oracle provides a PL/SQL wrapper
package so that the methods can be called directly from SQL. The package
includes methods to format a query result as an XML document, and to insert
an XML document into a database table. However, <emphasis>you cannot specify a URL
as the document source</emphasis>; the document must already be stored locally in a
CLOB or varchar variable. It would be easy to write a stored procedure in
Java that performed the retrieval (the Oracle Java classes support this
form), but Oracle requires you to have special permissions to open a socket
from a Java stored procedure. We will rely on AOLserver to do the retrieval
for us.</para>

</sect2>

<sect2 id="working-with-xml-prep">
<title>Preparation: Load the Utility</title>


<para>The first step in any XML project is to load the Java classes and PL/SQL
package into your tablespace. The whole package is available from the Oracle
web site at <ulink url="http://technet.oracle.com/tech/xml/oracle_xsu/">http://technet.oracle.com/tech/xml/oracle_xsu/</ulink>
. You may have to register with Oracle TechNet to get it.</para>

<para>Once you have managed to get the tar file onto your server, explode it and
change to the <computeroutput>lib</computeroutput> directory. Edit the database user and password in
the file <computeroutput>oraclexmlsqlload.csh</computeroutput> and run the script from the shell
command line. This will load everything and perform some tests to ensure that
it is working properly.</para>

</sect2>

<sect2 id="working-with-xml-ex-data-model">
<title>Example data model</title>


<para>For the examples below, suppose that you have this database table you want
to publish as XML:</para>

<programlisting>
create table xmltest (
    pk        integer primary key,
    color     varchar2(40),
    shape     varchar2(40)
);

insert into xmltest values (1, &#39;red&#39;, &#39;circle&#39;); 
insert into xmltest values (2, &#39;blue&#39;, &#39;triangle&#39;); 
insert into xmltest values (3, &#39;green&#39;, &#39;square&#39;); 

commit;
</programlisting>

</sect2>

<sect2 id="working-with-xml-creating-xml">
<title>Creating XML from Oracle table data</title>


<para>The Oracle package <computeroutput>xmlgen</computeroutput> allows you to publish any query result
as an XML document. As an example, we will publish the simplest possible
query:</para>

<programlisting>
select * from xmltest;
</programlisting>

<para>The Oracle package <computeroutput>xmlgen</computeroutput> has a <computeroutput>getXML</computeroutput> function that
turns a query into a simple XML document. You might hope that something like
this would work:</para>

<programlisting>
<computeroutput>select xmlgen.getXML(&#39;select * from xmltest&#39;) from dual;
</computeroutput>
</programlisting>

<para>This works fine in SQL*plus, but only works <emphasis>once</emphasis> per session if
called from AOLserver. This probably has to do with the fact that the
function returns a temporary CLOB which has to be freed before the function
can be called again, although this doesn&#39;t really explain why it works in
SQL*plus.</para>

<para>The workaround is to use a <emphasis>temporary table</emphasis>, which is a new
feature in Oracle 8i that stores session- or transaction- specific
information and deletes it at the end of the session or transaction. This
table will hold the XML document CLOB long enough to get it into a Tcl
string. We will use the <computeroutput>on commit delete rows</computeroutput> option (this is the
default) so that any rows inserted during a transaction are deleted at the
end of the transaction.</para>

<para>First you have a create a table to store the generated XML documents. Here
is a skeleton table, although you may want to extend it to suit your
needs:</para>

<programlisting>
create sequence xmldoc_seq start with 1;

create global temporary table xmldocs (
    doc_id        integer primary key,
    doc           CLOB
) on commit delete rows;
</programlisting>

<para>Next, you need a PL/SQL wrapper function that generates the XML document
into the temporary CLOB, stores it, and returns the id of the stored
document:</para>

<programlisting>
create or replace function get_xml (
  query varchar2) 
  return integer is
  doc_id integer;
begin
  select xmldoc_seq.nextval into doc_id from dual;
  insert into xmldocs values (doc_id, xmlgen.getXML(query));
  return doc_id;
end;
/
show errors;
</programlisting>

</sect2>

<sect2 id="working-with-xml-publish">
<title>Publish an XML document from Oracle data</title>


<para>To actually publish the query as an XML document, create an AOLserver tcl
page called <computeroutput>xmltest-publish</computeroutput>:</para>

<programlisting>
db_transaction {

set doc_id [ns_ora exec_plsql $db &quot;
  begin 
    :1 := get_xml(&#39;select * from xmltest&#39;);
  end;
&quot;]

set result [ns_db 1row $db &quot;select doc from xmldocs where doc_id = $doc_id&quot;]

set xmldoc [ns_set value $result 0]

}

ns_return 200 text/plain $xmldoc
</programlisting>

<para>This code obtains the document ID from the <computeroutput>get_xml</computeroutput> function
created above, and then retrieves the actual document. Note that the
<computeroutput>ns_ora exec_plsql</computeroutput> procedure must be used because the function has
the side effect of inserting a row into a table. The entire block is wrapped
in a transaction so that the generated XML document is automatically deleted
once the page is written.</para>

</sect2>

<sect2 id="working-with-xml-retrieving">
<title>Retrieving an XML document and store its data in an Oracle table</title>


<para>To retrieve an XML document and store its field values into a database
table, create another copy of the above table named <computeroutput>xmltest2</computeroutput>. Then
create an AOLserver tcl page called <computeroutput>xmltest-retrieve</computeroutput>:</para>

<programlisting>
set xmldoc [ns_httpget http://yourdomain/xmltest-publish]

regsub -all &quot;\[\r\n\]&quot; $xmldoc {} xmldoc



set statement &quot;
declare
  rowsp integer;
begin
  rowsp := xmlgen.insertXML(&#39;xmltest2&#39;, [ns_dbquotevalue $xmldoc]);
end;
&quot;

db_dml unused $statement

ns_return 200 text/html &quot;XML inserted.&quot;
</programlisting>

<para>Once the XML document is retrieved using the <computeroutput>ns_httpget</computeroutput> method,
all line breaks in the document must be removed to avoid breaking the SQL
statement. The <computeroutput>insertXML</computeroutput> function itself must be executed within a
PL/SQL block; it returns the number of rows successfully inserted.</para>

</sect2>

<sect2 id="working-with-xml-xsl">
<title>Transforming an XML document with an XSL stylesheet</title>


<para>Version 2 of the Oracle XML parser supports XSL stylesheets, which provide
a convenient way to transform XML documents into HTML or any other format.
The <computeroutput>xmlgen</computeroutput> PL/SQL package does not provide this capability, but I
have created my own Java code to support such transformations. The code is
invoked by the <computeroutput>apply_xsl</computeroutput> procedure in SQL/plus. It can be found in
<computeroutput>doc/sql/XMLPublisher</computeroutput> in the ACS distribution.</para>

<para>To use the function, you need a table to store XSL stylesheets in the
database:</para>

<programlisting>
create sequence xsldoc_seq start with 1;

create table xsldocs (
    doc_id        integer primary key,
    doc_name      varchar2(100),
    doc           CLOB
);
</programlisting>

<para>Once you have inserted a stylesheet into the table, you can apply it to
any generated xml document. Simply generate the XML document into the
<computeroutput>xmldocs</computeroutput> table as above, and then call <computeroutput>apply_xsl</computeroutput> to apply a
transformation:</para>

<programlisting>
...

set doc_id [ns_ora exec_plsql $db &quot;
  begin
    :1 := get_xml(&#39;select * from xmltest&#39;);
    apply_xsl(:1, &#39;mystyle.xsl&#39;);
  end;
&quot;]

...
</programlisting>

<para>The <computeroutput>apply_xsl</computeroutput> procedure is bound to a Java stored procedure that
retrieves the document from the <computeroutput>xmldocs</computeroutput> temporary table the named
stylesheet from the <computeroutput>xsldocs</computeroutput> table. It applies the transformation to
the document and updates the xmldocs table with the transformed version of
the XML document, which can then be retrieved as before.</para>

<para><phrase role="cvstag">($Id$)</phrase></para>

</sect2>

</sect1>

